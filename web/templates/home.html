<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="author" content="BotoX">
<meta name="description" content="Xiaomi Mi 1S / Pro2 VLT Custom Firmware Toolkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
<title>Xiaomi Mi 1S / Pro2 VLT Custom Firmware Toolkit</title>
</head>

<body>

<div class="header">
    <h1>Xiaomi Mi 1S / Pro2 VLT Custom Firmware Toolkit</h1>
</div>

<div class="content">
<p>
    Configure your own custom firmware by adjusting the options below.<br>
    There are safety checks in place to ensure your scooter will not be bricked.<br>
    Be aware that a higher motor power will shorten the lifetime of your battery and could damage your motor.<br>
    By default nothing will be patched, enable patches with the "Patch?" checkbox next to them.
</p>

<p>
    Presets:
    <button onclick="Preset_Mi1S();">Mi 1S (default)</button>
    <button onclick="Preset_MiPro2();">Mi Pro2 (default)</button>
</p>

<noscript>This website (despite it's look) requires some very simple JavaScript which is embedded in this HTML.</noscript>

<hr>
<form action="/cfw">
<ul>
    <li>
    <label><b>Base version of your firmware:</b>
    <select name="version">
        <option value="DRV236">2.3.6 (Mi Pro2)</option>
        <option value="DRV304">3.0.4 (Mi 1S)</option>
    </select></label>
    </li>

    <li>
    <label><b>Brakelight Mod</b>
        <input name="brakelight_mod" type="checkbox"></label>
    <p>
        Fixes blinking backlight for GM. The backlight behaves the same as before GM.
    </p>
    </li>

    <li>
    <label><b>22&nbsp;km/h Mod</b>
        <input name="speed_plus2" type="checkbox"></label>
    <p>
        Increases limit of sport mode to 22&nbsp;km/h, which is within the legal tolerance of "some" countries.
    </p>
    </li>

    <li>
    <label><b>Deactivate auto-brake (remove hard speed limit of 35&nbsp;km/h):</b>
    <input type="checkbox" name="remove_autobrake"></label>
    <p>Removes code which checks that the speed is below 34.78&nbsp;km/h (12000/345) and causes scooter to brake.</p>
    </li>

    <li>
    <label><b>Turn off KERS:</b>
        <input name="remove_kers" type="checkbox"></label>
    <p>
        Turns KERS completely off.
        You will still have recuperative braking when using the brake lever.<br>
    </p>
    </li>

    <li>
    <label><b>Motor start speed:</b>
    <input name="motor_start_speed" type="number" step="0.01" min="0" max="100" value="5.0" disabled>&nbsp;km/h</label>
    <label><input type="checkbox" onchange="CheckForm('motor_start_speed', this);">Patch?</label>
    <p>Minimum speed in km/h before the engine will start.</p>
    </li>

    <li>
    <label><b>Remove charging mode:</b>
    <input type="checkbox" name="remove_charging_mode"></label>
    <p>Fixes issue of scooter going into charge mode with an external battery connected in parallel.</p>
    </li>

    <li>
    <label><b>(UNTESTED!!!!!) Patch speed control params? </b>
    <input type="checkbox" name="speed_params" onchange="CheckForm('speed_ampere', this); CheckForm('normal_ampere', this); CheckForm('eco_ampere', this);"></label>
    <p><u>DC Motor Phase Current</u><br />
        <label>Speed Mode: <input name="speed_ampere" type="number" step="1" min="0" max="65535" value="25000" disabled>&nbsp;mA</label><br>
        <label>Normal Mode: <input name="normal_ampere" type="number" step="1" min="0" max="65535" value="17000" disabled>&nbsp;mA</label><br>
        <label>Eco Mode: <input name="eco_ampere" type="number" step="1" min="0" max="65535" value="7000" disabled>&nbsp;mA</label>
    </p>
    </li>

</ul>
<hr>

<p>
    Make sure to double check all of your entered values before submitting!<br>
    <b>I AM RESPONSIBLE FOR THE ENTERED VALUES:</b>
    <input type="submit" value="Patch!"/>
    <button type="button" onclick="Share();">Share</button>
    <span id="shareConfirmation"></span>
</p>
</form>

<p>
    <b><span style="color: red;">&#9888;&nbsp;NEW </span>The tool now makes .zip files with both encrypted and unencrypted firmware and an info.txt inside.</b><br>
    <b><span style="color: red;">&#9888;&nbsp;NEW </span>Use the following app made by <a href="https://github.com/CamiAlfa">CamiAlfa</a> to flash your modified firmware: <a href="https://play.google.com/store/apps/details?id=com.m365downgrade">m365 DownG</a></b><br>
    It will automatically chose the correct firmware for your scooter. Don't try to flash the .zip file with the old patched app!
</p>

<hr>
<p>
    Credits go to VooDooShamane (RollerPlausch) for <a href="https://rollerplausch.com/threads/vlt-firmwares-in-de-22kmh-mit-neuster-vanilla-firmware-und-vieles-mehr.3197/">his work</a> on figuring out and testing the offsets!
    Speed control patches for DRV236/DRV304 by dnandha.
</p>
<p>
Mi 1S / Pro2 VLT Firmware Patcher by dnandha: <a href="https://github.com/dnandha/vlt-firmware-patcher" target="_blank">https://github.com/dnandha/vlt-firmware-patcher</a> <br/>
    Based on BotoX m365 firmware patcher: <a href="https://github.com/BotoX/xiaomi-m365-firmware-patcher" target="_blank">https://github.com/BotoX/xiaomi-m365-firmware-patcher</a>
</div>

<script>
    var forms = {
        "VERSION": "version",
        "BRAKELIGHT_MOD": "brakelight_mod",
        "SPEED_PLUS2": "speed_plus2",
        "MOTOR_START_SPEED": "motor_start_speed",
        "REMOVE_KERS": "remove_kers",
        "REMOVE_AUTOBRAKE": "remove_autobrake",
        "REMOVE_CHARGING_MODE": "remove_charging_mode",
        "SPEED_PARAMS": "speed_params",
        "SPEED_AMPERE": "speed_ampere",
        "NORMAL_AMPERE": "normal_ampere",
        "ECO_AMPERE": "eco_ampere",
    };

    var formValues = Object.values(forms);
    var queryStrings = window.location.search.substring(1);
    var queries = queryStrings.split('&');

    for (var i = 0; i < queries.length; i++) {
        var query = queries[i];
        var tmp = query.split('=');
        var found = false;

        for (var j = 0; j < formValues.length; j++) {
            if (formValues[j] === tmp[0]) {
                found = true;
                break;
            }
        }

        if(found) {
            if (tmp[1] === 'on') {
                tmp[1] = true;
            }

            ChangeForm(tmp[0], tmp[1], true);
        }
    }

    function GetForm(name) {
        return document.getElementsByName(name)[0];
    }

    function GetFormValue(name) {
        var o = GetForm(name);

        if (o.type === "checkbox") {
            return o.checked;
        }

        return o.value;
    }

    function GetPatchCheckBox(name) {
        var form = GetForm(name);
        if(form.type != "checkbox") {
            return form.parentElement && form.parentElement.nextElementSibling && form.parentElement.nextElementSibling.children[0];
        }
    }

    function CheckForm(name, cb) {
        GetForm(name).disabled = !cb.checked;
    }

    function ChangeForm(name, value, patch) {
        var o = GetForm(name);

        if (o.type === "checkbox") {
            o.checked = value;
        } else {
            o.value = value;
        }
        if(o.onchange) { o.onchange(); }

        if (typeof patch === 'boolean') {
            var cb = GetPatchCheckBox(name);

            if (cb) {
                cb.checked = patch;
                if(cb.onchange) { cb.onchange(); }
            }
        }
    }

    function Preset_Default() {
        ChangeForm(forms.BRAKELIGHT_MOD, false);
        ChangeForm(forms.SPEED_PLUS2, false);
        ChangeForm(forms.MOTOR_START_SPEED, "5.0", false);
        ChangeForm(forms.REMOVE_KERS, false);
        ChangeForm(forms.REMOVE_AUTOBRAKE, false);
        ChangeForm(forms.REMOVE_CHARGING_MODE, false);
	ChangeForm(forms.SPEED_PARAMS, false);
    }

    function Preset_Mi1S() {
	Preset_Default();
        ChangeForm(forms.VERSION, "DRV304");
	ChangeForm(forms.SPEED_AMPERE, "20000");
	ChangeForm(forms.NORMAL_AMPERE, "15000");
	ChangeForm(forms.ECO_AMPERE, "7000");
    }

    function Preset_MiPro2() {
	Preset_Default();
        ChangeForm(forms.VERSION, "DRV236");
	ChangeForm(forms.SPEED_PARAMS, false);
	ChangeForm(forms.SPEED_AMPERE, "25000");
	ChangeForm(forms.NORMAL_AMPERE, "17000");
	ChangeForm(forms.ECO_AMPERE, "7000");
    }

    function Share() {
        var url = location.protocol + '//' + location.host;
        var firstParam = true;

        function getSeparator() {
            if (firstParam) {
                firstParam = false;
                return '?';
            }

            return '&';
        }

        for (var i = 0; i < formValues.length; i++) {
            var form = formValues[i];

            var formValue = GetFormValue(form);
            var patchCheckbox = GetPatchCheckBox(form);

            if (patchCheckbox) {
                if (patchCheckbox.checked) {
                    url += getSeparator() + form + '=' + formValue;
                }
            } else if (typeof formValue === 'boolean') {
                if (formValue) {
                    url += getSeparator() + form + '=on';
                }
            } else {
                url += getSeparator() + form + '=' + formValue;
            }
        }

        var textArea = document.createElement("textarea");

        textArea.value = url;
        document.body.appendChild(textArea);

        textArea.focus();
        textArea.select();

        document.execCommand('copy');
        document.getElementById('shareConfirmation').innerText = 'Copied!';

        document.body.removeChild(textArea);
    }
</script>

</body>
