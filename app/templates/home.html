<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="author" content="BotoX">
<meta name="description" content="Xiaomi Mi 1S / Pro2 VLT Custom Firmware Toolkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='newstyle.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='bootstrap.min.css') }}">

<title>Xiaomi Mi 1S / Pro2 VLT Custom Firmware Toolkit</title>
</head>

<body onload="ChangeVersion()">

<noscript>Diese Webseite benötigt JavaScript.</noscript>

<div class="container">
    <div class="row"><div class="col center-block text-center">
        <h1>VLT Firmwares für Mi 1S / Pro2</h1>
    </div></div>

    <div class="row"><div class="col">
        Konfiguriere deine eigene VLT Firmware durch Anpassung der unten stehenden Optionen.
        Sei gewarnt, dass eine höhere Motorleistung die Lebenszeit deiner Batterie verkürzt und deinen Motor schädigen kann. Standardmäßig wird nichts gepatcht, sondern erst wenn eine Checkbox aktiviert wird.<br/>
    </div></div>

    <hr>
    <form action="/cfw"  method = "POST" enctype = "multipart/form-data">
    <div class="card text-center">
        <div class="card-header"><b>Basis Firmware Version</b></div>

        <div class="card-body">
            <select class="form-select" id="verselect" name="version" onchange="ChangeVersion()">
                <option value="DRV236">2.3.6 (Mi Pro2)</option>
                <option value="DRV304">3.0.4 (Mi 1S)</option>
            </select>
        </div>
    </div>
    <div class="card-group">
        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" name="brakelight_mod" type="checkbox">
                <label class="form-check-label"><b>Bremslicht Mod</b></label>
            </div>
            <div class="card-body">
                <div class="card-text">
                    Bei Aktivem GM verhält sich das Rücklicht wie als wenn GM nicht Aktiv ist.
                    Es Blinkt nicht wenn man die Bremse betätigt oder vom Gas geht.
                </div>
            </div>
        </div>

        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" name="speed_plus2" type="checkbox">
                <label class="form-check-label"><b>22&nbsp;km/h Mod</b></label>
            </div>

            <div class="card-body">
                Hebt das Deutsche Geschwindigkeits Limit des Sport Modus auf 22Kmh an.
                Nutzt die Aktuelle Gesetzeslage komplett aus, da man aktuell in DE 20 + 2Kmh Toleranz schnell fahren darf. Nicht wundern, Der Tacho vom Pro 2 zeigt nach 2-3 sekunden Top Speed nur 21Kmh an. Es schwankt aber zwischen 21,4 - 21,8 Kmh nur wird es mangels Display Funktion nicht angezeigt.
            </div>
        </div>
    </div>
    <div class="card-group">
        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" name="remove_autobrake">
                <label class="form-check-label"><b>Automatisches abbremsen deaktivieren</b></label>
            </div>
            <div class="card-body">
                <div class="card-title"><i>Remove 30km/h speed check</i></div>
                <div class="card-text">
                    Der Roller bremst bei overspeed nicht mehr automatisch ab und piepst auch nicht.
                    Z.b. wenn man einen Hang runter rollt (wenn man vom Gas geht greift natürlich trotzdem Kers) oder im leerlauf schnell auf Vmax beschleunigt. Es wird auch nicht von alleine über 20Kmh oder mit 22Kmh Mod über 22Kmh schnell wenn das Rad in der Luft dreht.
                </div>
            </div>
        </div>

        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" name="remove_kers" type="checkbox">
                <label class="form-check-label"><b>KERS ausschalten</b></label>
            </div>
            <div class="card-body">
                Rekuperation (KERS) wird beim Ausrollen komplett entfernt.
                Energierückgewinnung greift nur noch wenn die elektrische Bremse (Rechts) betätigt wird.
            </div>
        </div>

    </div>
    <div class="card-group">
        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" onchange="CheckForm('motor_start_speed', this);">
                <label class="form-check-label"><b>Motor Startgeschwindigkeit</b></label>
            </div>
            <div class="card-body">
                <div class="card-title input-group">
                    <input class="form-control" name="motor_start_speed" type="number" step="0.1" min="0" max="10" value="5" disabled>
                    <span class="input-group-text">km/h</span>
                </div>
                <div class="card-text">
                    Die Startgeschwindigkeit bei dem der Motor aktiviert wird.
                    Standard ist 5-Kmh. 0-Kmh braucht trotzdem einen winzigen Stubser damit der Motor los geht.
                </div>
            </div>
        </div>

        <div class="card text-center">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" name="remove_charging_mode">
                <label class="form-check-label"><b>Zusatzakku Fix</b></label>
            </div>
            <div class="card-body">
                <div class="card-title"><i>Remove charging mode</i></div>
                <div class="card-text">
                    Zusatzakku Auflade Fix.
                    Roller fährt, trotz alledem der interne Akku vom Externen geladen wird.
                </div>
            </div>
        </div>

    </div>
    <div class="card-group">
        <div class="card text-center border-danger text-danger">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" name="dpc">
                <label class="form-check-label"><b>DPC (Experimental!)</b></label>
            </div>

            <div class="card-body">
                DPC Aktivierung und Deaktivierung erfolgt über eine Register Flag.
                Bei Neustart bzw. Ausschalten des Rollers wird DPC ebenfalls zurückgesetzt.

                Erfolgreich getestet auf Mi Pro2. Mi 1S noch nicht getestet.
            </div>
        </div>

        <div class="card text-center border-danger text-danger">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" onchange="CheckForm('wheelsize', this);">
                <label class="form-check-label"><b>Rad Durchmesser (Experimental!)</b></label>
            </div>

            <div class="card-body">
                <div class="card-title input-group">
                    <input class="form-range" name="wheelsize" type="range" step="0.1" min="10" max="50" value="21.5" disabled oninput=wheelsizeChange()>
                    <span class="input-group-text"><div name="wheelsize_value">5</div>&nbsp;cm</span>
                </div>
                <div class="card-text">
                    UNGETESTET!!
                </div>
            </div>
        </div>
    </div>

    <div class="card-group">
        <div class="card text-center border-danger text-danger">
            <div class="card-header">
                <input class="form-check-input" type="checkbox" name="speed_params" onchange="CheckForm('speed_ampere', this); CheckForm('normal_ampere', this); CheckForm('eco_ampere', this);">
                <label class="form-check-label"><b>Nennstrom (Experimental!)</b></label>
            </div>
            <div class="card-body">
                <div class="card-title">
                    <div class="row">
                        <div class="col">
                            <label class="form-check-label">Speed Mode (mA):</label>
                            <input class="form-control" name="speed_ampere" type="number" step="1" min="0" max="30000" value="25000" disabled>
                        </div>
                        <div class="col" hidden>
                            <label class="form-check-label">Normal Mode (mA):</label>
                            <input class="form-control" name="normal_ampere" type="number" step="1" min="0" max="30000" value="17000" disabled>
                        </div>
                        <div class="col" hidden>
                            <label class="form-check-label">Eco Mode (mA):</label>
                            <input class="form-control" name="eco_ampere" type="number" step="1" min="0" max="30000" value="7000" disabled>
                        </div>
                    </div>
                </div>
                <div class="card-text">
                    Achtung: Aktuell wird nur der Wert für den Speed Mode übernommen. Bitte nicht über 30A gehen, da sonst die Batterie Schaden nimmt!

                    Erfolgreich getestet auf Mi Pro2. Mi 1S noch nicht getestet.
                </div>
            </div>
        </div>

        <div class="card text-center border-danger text-danger" hidden>
            <div class="card-header">
                <input class="form-check-input" type="checkbox" name="speed_limit">
                <label class="form-check-label"><b>Speedlimit (NICHT IMPLEMENTIERT)</b></label>
            </div>

            <div class="card-body">
                NICHT IMPLEMENTIERT
            </div>
        </div>
    </div>
    <hr>

    <div class="row">
        <div class="col-sm-4">
            Achtung: Bitte prüfe vor dem Patchen erneut, ob alle gemachten Eingaben passen!!<br />
        </div>
        <div class="col">
            <b><label id="drvselect" for="file">Datei auswählen:</label></b>

              <input type="file" id="file" name="filename">
          <input type="submit" value="Patch!">

            <input class="form-check-input" name="testzip" type="checkbox">
            <label class="form-check-label"><b>TESTZIP</b></label>
        </div>
    </div>

    </form>

    <div class="row">
        <div class="col">
            <b><span style="color: red;">&#9888;&nbsp;NEW </span>Dieses Tool erstellt eine .zip Datei mit sowohl verschlüsselter als auch entschlüsselter Firmware und einer info.txt.</b><br>
            <b><span style="color: red;">&#9888;&nbsp;NEW </span>Zum Flashen benutze z.B. von CamiAlfa die App <a href="https://play.google.com/store/apps/details?id=com.m365downgrade">m365 DownG</a></b>.
            Sie wählt automatisch die korrekte Firmware für deinen Scooter. Bitte nicht die .zip Datei mit alten / gepatchten Apps flashen!
        </div>
    </div>

    <hr>
    <div class="row">
        <div class="col">
            Credits an VooDooShamane (RollerPlausch) für <a href="https://rollerplausch.com/threads/vlt-firmwares-in-de-22kmh-mit-neuster-vanilla-firmware-und-vieles-mehr.3197/">seine Arbeit</a> an den Offsets!
            Leistungsparameter, DPC und Wheelsize Mod für DRV236/DRV304 von NandTek.
        </div>
    </div>
    <div class="row">
        <div class="col">
            Mi 1S / Pro2 VLT Firmware Patcher by dnandha: <a href="https://github.com/dnandha/vlt-firmware-patcher" target="_blank">https://github.com/dnandha/vlt-firmware-patcher</a> <br/>
            Basiert auf BotoX' m365 Firmware Patcher: <a href="https://github.com/BotoX/xiaomi-m365-firmware-patcher" target="_blank">https://github.com/BotoX/xiaomi-m365-firmware-patcher</a>
        </div>
    </div>
</div>

<script>
    var forms = {
        "VERSION": "version",
        "BRAKELIGHT_MOD": "brakelight_mod",
        "SPEED_PLUS2": "speed_plus2",
        "MOTOR_START_SPEED": "motor_start_speed",
        "REMOVE_KERS": "remove_kers",
        "REMOVE_AUTOBRAKE": "remove_autobrake",
        "REMOVE_CHARGING_MODE": "remove_charging_mode",
        "SPEED_PARAMS": "speed_params",
        "SPEED_AMPERE": "speed_ampere",
        "NORMAL_AMPERE": "normal_ampere",
        "ECO_AMPERE": "eco_ampere",
        "DPC": "dpc",
        "WHEELSIZE": "wheelsize",
    };

    var formValues = Object.values(forms);
    var queryStrings = window.location.search.substring(1);
    var queries = queryStrings.split('&');

    for (var i = 0; i < queries.length; i++) {
        var query = queries[i];
        var tmp = query.split('=');
        var found = false;

        for (var j = 0; j < formValues.length; j++) {
            if (formValues[j] === tmp[0]) {
                found = true;
                break;
            }
        }

        if(found) {
            if (tmp[1] === 'on') {
                tmp[1] = true;
            }

            ChangeForm(tmp[0], tmp[1], true);
        }
    }

    function GetForm(name) {
        return document.getElementsByName(name)[0];
    }

    function GetFormValue(name) {
        var o = GetForm(name);

        if (o.type === "checkbox") {
            return o.checked;
        }

        return o.value;
    }

    function GetPatchCheckBox(name) {
        var form = GetForm(name);
        if(form.type != "checkbox") {
            return form.parentElement && form.parentElement.nextElementSibling && form.parentElement.nextElementSibling.children[0];
        }
    }

    function CheckForm(name, cb) {
        GetForm(name).disabled = !cb.checked;
    }

    function ChangeForm(name, value, patch) {
        var o = GetForm(name);

        if (o.type === "checkbox") {
            o.checked = value;
        } else {
            o.value = value;
        }
        if(o.onchange) { o.onchange(); }

        if (typeof patch === 'boolean') {
            var cb = GetPatchCheckBox(name);

            if (cb) {
                cb.checked = patch;
                if(cb.onchange) { cb.onchange(); }
            }
        }
    }

    function ChangeVersion(version){
        var version = document.getElementById("verselect").value;
        var name = document.getElementById("drvselect").value;
        if (version === "DRV236") {
            Preset_MiPro2();
        } else if (version === "DRV304") {
            Preset_Mi1S();
        }

        document.getElementById("drvselect").innerHTML = `"${version}.bin" auswählen:`;
    }


    function Preset_Default() {
        ChangeForm(forms.BRAKELIGHT_MOD, false);
        ChangeForm(forms.SPEED_PLUS2, false);
        ChangeForm(forms.MOTOR_START_SPEED, "5", false);
        ChangeForm(forms.REMOVE_KERS, false);
        ChangeForm(forms.REMOVE_AUTOBRAKE, false);
        ChangeForm(forms.REMOVE_CHARGING_MODE, false);
        ChangeForm(forms.SPEED_PARAMS, false);
        ChangeForm(forms.DPC, false);
        ChangeForm(forms.WHEELSIZE, "21.5", false);
    }

    function Preset_Mi1S() {
        Preset_Default();
        //ChangeForm(forms.VERSION, "DRV304");
        ChangeForm(forms.SPEED_AMPERE, "20000");
        ChangeForm(forms.NORMAL_AMPERE, "15000");
        ChangeForm(forms.ECO_AMPERE, "7000");
    }

    function Preset_MiPro2() {
        Preset_Default();
        //ChangeForm(forms.VERSION, "DRV236");
        ChangeForm(forms.SPEED_AMPERE, "25000");
        ChangeForm(forms.NORMAL_AMPERE, "17000");
        ChangeForm(forms.ECO_AMPERE, "7000");
    }
</script>

</body>
